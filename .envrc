# .envrc - direnv configuration for Ansible playbook environment
#
# Automatically configures environment when entering this directory:
#   - Adds ./bin shims to PATH (ansible, ansible-playbook, etc.)
#   - Sets ANSIBLE_CONFIG to project's ansible.cfg
#   - Configures vault password file location
#   - Loads bash completions for Ansible commands
#
# Requirements:
#   - direnv (https://direnv.net/)
#   - Run 'direnv allow' after checkout
#
# Usage:
#   cd /path/to/ansible/project  # Auto-loaded by direnv
#   ansible --version             # Uses project-specific ansible via uv
# Make repo shims take precedence

# PATH cofiguration
# Make repo shims take precedence over system ansible
# This ensures 'ansible' commands use the uv-managed version with locked dependencies
PATH_add ./bin


# Project Root Detection
# Determine project root (git repo root or current directory)
# This allows the .envrc to work correctly even when in subdirectories
if git rev-parse --show-toplevel >/dev/null 2>&1; then
  PROJECT_ROOT="$(git rev-parse --show-toplevel)"
else
  PROJECT_ROOT="${PWD}"
fi


# Ansible Configuration
# Point Ansible to project-specific configuration
ANSIBLE_CONFIG="${PROJECT_ROOT}/ansible.cfg"

# Vault password file location
if [[ -f "${PROJECT_ROOT}/.vault-pass" ]]; then
  ANSIBLE_VAULT_PASSWORD_FILE="${PROJECT_ROOT}/.vault-pass"
else
  ANSIBLE_VAULT_PASSWORD_FILE="${HOME}/.ansible-vault-pass"
fi

export ANSIBLE_CONFIG ANSIBLE_VAULT_PASSWORD_FILE


# Shell Completions
# Load Ansible command completions (bash-style)
# Zsh users: Enable bashcompinit in your .zshrc first:
#   autoload -U +X bashcompinit && bashcompinit
if [ -n "${ZSH_VERSION:-}" ] && ! typeset -f bashcompinit >/dev/null 2>&1; then
  # Zsh detected but bashcompinit not enabled
  # User needs to enable bashcompinit in .zshrc
  :
else
  # Load bash completion definitions if available
  COMPDIR="${PROJECT_ROOT}/.direnv/completions"
  if [ -d "${COMPDIR}" ]; then
    for def in "${COMPDIR}"/*.bash; do
      [ -r "${def}" ] && . "${def}"
    done
  fi
fi


# Local Overrides

# Load local environment variables (gitignored)
dotenv_if_exists .env.local

# Load developer-specific direnv customizations (gitignored)
source_env_if_exists .envrc.local


# Optional: Watch Files to reload .envrc when these files change (useful during development)
# watch_file .git/HEAD  # Watch for git initialization (optional but nice)
# watch_file ansible.cfg
# watch_file requirements.txt
# watch_file pyproject.toml

# vim: ft=sh ts=2 sts=2 sw=2 sr et
